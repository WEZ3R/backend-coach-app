// This is your Prisma schema file
// Documentation: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enumérations
enum UserRole {
  COACH
  CLIENT
}

enum SessionStatus {
  EMPTY
  DRAFT
  DONE
}

enum ExerciseCategory {
  WARMUP      // Échauffement
  MAIN        // Exercices principaux (musculation)
  CARDIO      // Exercices cardio
  STRETCHING  // Étirements
}

enum MessageType {
  CHAT
  TIP
  APPOINTMENT_PROPOSAL
}

enum AppointmentStatus {
  PROPOSED
  CONFIRMED
  CANCELLED
}

enum LocationType {
  PHYSICAL
  REMOTE
}

// Modèle User principal
model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  role      UserRole
  firstName String?
  lastName  String?
  phone     String?
  birthDate DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  coachProfile  CoachProfile?
  clientProfile ClientProfile?

  @@map("users")
}

// Profil Coach
model CoachProfile {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bio            String?
  experience     String?
  rating         Float    @default(0)
  ratingCount    Int      @default(0)
  profilePicture String?  // URL de la photo de profil
  city           String?  // Ville du coach
  isRemote       Boolean  @default(false) // Coaching à distance
  trainingLocations String[] // Lieux d'entraînement (array)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  clients          ClientProfile[]     @relation("ClientCoach") // Ancien champ pour rétrocompatibilité
  clientCoaches    ClientCoach[]       // Nouvelle relation many-to-many
  programs         Program[]
  programTemplates ProgramTemplate[]
  sentMessages     Message[]           @relation("CoachMessages")
  channels         Channel[]
  reviews          Review[]
  posts            CoachPost[]         // Posts du mur du coach
  coachRequests    CoachRequest[]      // Demandes reçues
  appointments     Appointment[]       @relation("CoachAppointments")

  @@map("coach_profiles")
}

// Profil Client
model ClientProfile {
  id             String    @id @default(uuid())
  userId         String    @unique
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  coachId        String?   // Coach principal (pour rétrocompatibilité)
  coach          CoachProfile? @relation("ClientCoach", fields: [coachId], references: [id])
  weight         Float?    // Poids initial en kg
  height         Float?    // Taille en cm
  dateOfBirth    DateTime? // Date de naissance pour calculer l'âge
  gender         String?   // Genre: M, F, ou X
  goals          String?   // Objectifs du client
  level          String?   // Niveau: débutant, intermédiaire, avancé
  profilePicture String?   // URL de la photo de profil
  city              String?   // Ville du client
  trainingLocations String[] // Lieux d'entraînement (array)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  coaches          ClientCoach[]   // Nouvelle relation many-to-many
  stats            DailyStat[]
  meals            Meal[]
  receivedMessages Message[]       @relation("ClientMessages")
  reviews          Review[]
  coachRequests    CoachRequest[]  // Demandes envoyées
  appointments     Appointment[]   @relation("ClientAppointments")

  @@map("client_profiles")
}

// Table de liaison Client-Coach (relation many-to-many)
model ClientCoach {
  id          String        @id @default(uuid())
  clientId    String
  client      ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  coachId     String
  coach       CoachProfile  @relation(fields: [coachId], references: [id], onDelete: Cascade)
  isPrimary   Boolean       @default(false) // Indique si c'est le coach principal
  startDate   DateTime      @default(now()) // Date de début de la relation
  endDate     DateTime?     // Date de fin (si la relation se termine)
  isActive    Boolean       @default(true)  // Relation active ou non
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([clientId, coachId])
  @@map("client_coaches")
}

// Programme d'entraînement
model Program {
  id          String   @id @default(uuid())
  coachId     String
  coach       CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  clientId    String
  title       String
  description String?  // Description optionnelle
  cycleDays   Int?     // Durée du cycle en jours (optionnel)
  startDate   DateTime
  endDate     DateTime?  
  isActive    Boolean  @default(true)

  // Options de suivi
  dietEnabled            Boolean @default(false)
  dietType               String? // 'calories' ou 'menu'
  targetCalories         Int?
  waterTrackingEnabled   Boolean @default(false)
  waterGoal              Float?  // Objectif d'eau en litres
  sleepTrackingEnabled   Boolean @default(false)
  weightTrackingEnabled  Boolean @default(false) // Suivi quotidien du poids

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  sessions Session[]
  mealPlans MealPlan[]
  customGoals CustomGoal[]

  @@map("programs")
}

// Programme type (template) réutilisable par le coach
model ProgramTemplate {
  id          String   @id @default(uuid())
  coachId     String
  coach       CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  name        String
  description String?

  // Configuration du programme
  cycleDays   Int?     // Durée du cycle en jours (optionnel)

  // Options de suivi
  dietEnabled            Boolean @default(false)
  dietType               String? // 'calories' ou 'menu'
  targetCalories         Int?
  waterTrackingEnabled   Boolean @default(false)
  waterGoal              Float?  // Objectif d'eau en litres
  sleepTrackingEnabled   Boolean @default(false)
  weightTrackingEnabled  Boolean @default(false) // Suivi quotidien du poids

  // Données structurées des séances et objectifs (stockées en JSON)
  sessionsData    Json?  // Structure des séances avec exercices
  customGoalsData Json?  // Liste des objectifs personnalisés

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("program_templates")
}

// Objectif quotidien personnalisé par le coach
model CustomGoal {
  id          String   @id @default(uuid())
  programId   String
  program     Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  title       String   // Ex: "Faire 10 minutes de méditation"
  description String?  // Description optionnelle
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  completions GoalCompletion[]

  @@map("custom_goals")
}

// Completion d'un objectif par le client (par jour)
model GoalCompletion {
  id           String     @id @default(uuid())
  customGoalId String
  customGoal   CustomGoal @relation(fields: [customGoalId], references: [id], onDelete: Cascade)
  clientId     String
  date         DateTime   // Date de completion
  completed    Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([customGoalId, clientId, date])
  @@map("goal_completions")
}

// Séance d'entraînement (par jour)
model Session {
  id          String        @id @default(uuid())
  programId   String
  program     Program       @relation(fields: [programId], references: [id], onDelete: Cascade)
  date        DateTime
  status      SessionStatus @default(EMPTY)
  isRestDay   Boolean       @default(false)
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  exercises Exercise[]
  comments  Comment[]

  @@unique([programId, date])
  @@map("sessions")
}

// Exercice
model Exercise {
  id          String           @id @default(uuid())
  sessionId   String
  session     Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  name        String
  category    ExerciseCategory
  sets        Int?
  reps        String?          // Peut être "12" ou "12-15" ou "AMRAP"
  weight      String?
  restTime    String?          // Ex: "90s", "2min"
  videoUrl    String?
  gifUrl      String?
  description String?
  order       Int              @default(0)
  duration    String?          // Durée pour cardio/stretching
  exerciseRefId String?        // Référence vers ExerciseDB
  exerciseRef   ExerciseReference? @relation(fields: [exerciseRefId], references: [id])
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  setCompletions SetCompletion[]

  @@map("exercises")
}

// Complétion d'une série (set) par le client
model SetCompletion {
  id          String    @id @default(uuid())
  exerciseId  String
  exercise    Exercise  @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  setNumber   Int       // Numéro de la série (1, 2, 3, etc.)
  repsAchieved String?  // Nombre de répétitions réalisées
  weightUsed   String?  // Poids utilisé
  completed    Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([exerciseId, setNumber])
  @@map("set_completions")
}

// Plan alimentaire
model MealPlan {
  id          String   @id @default(uuid())
  programId   String
  program     Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  title       String
  description String?
  dailyCalories Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  menuItems MenuItem[]

  @@map("meal_plans")
}

// Élément de menu (repas suggéré)
model MenuItem {
  id          String   @id @default(uuid())
  mealPlanId  String
  mealPlan    MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  mealType    String   // "breakfast", "lunch", "dinner", "snack"
  name        String
  description String?
  calories    Int?
  protein     Float?
  carbs       Float?
  fats        Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("menu_items")
}

// Repas réel enregistré par le client
model Meal {
  id          String        @id @default(uuid())
  clientId    String
  client      ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  date        DateTime
  mealType    String        // "breakfast", "lunch", "dinner", "snack"
  description String
  photoUrl    String?
  calories    Int
  protein     Float?
  carbs       Float?
  fats        Float?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("meals")
}

// Statistiques quotidiennes du client
model DailyStat {
  id              String        @id @default(uuid())
  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  date            DateTime      @unique
  sleepHours      Float?        // Heures de sommeil
  bedTime         DateTime?     // Heure de coucher
  wakeTime        DateTime?     // Heure de réveil
  waterIntake     Float?        // Litres d'eau
  weight          Float?        // Poids en kg
  totalCalories   Int?          // Calculé automatiquement depuis les repas
  workoutTime     DateTime?     // Heure de la séance
  workoutDuration Int?          // Durée en minutes
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([clientId, date])
  @@map("daily_stats")
}

// Commentaires du coach sur une journée
model Comment {
  id             String   @id @default(uuid())
  sessionId      String?
  session        Session? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  clientId       String
  content        String
  date           DateTime // Date concernée par le commentaire
  isPastComment  Boolean  @default(true) // true = commentaire sur jour passé, false = tip futur
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("comments")
}

// Messages entre coach et client
model Message {
  id                String        @id @default(uuid())
  coachId           String
  coach             CoachProfile  @relation("CoachMessages", fields: [coachId], references: [id], onDelete: Cascade)
  clientId          String
  client            ClientProfile @relation("ClientMessages", fields: [clientId], references: [id], onDelete: Cascade)
  content           String
  type              MessageType   @default(CHAT)
  scheduledTime     DateTime?     // Pour les tips planifiés
  isRead            Boolean       @default(false)
  isSentByCoach     Boolean       @default(true)
  appointmentId     String?       @unique
  appointment       Appointment?  @relation("AppointmentMessage", fields: [appointmentId], references: [id], onDelete: SetNull)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@map("messages")
}

// Canal d'information du coach
model Channel {
  id          String       @id @default(uuid())
  coachId     String
  coach       CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  title       String
  description String?
  content     String
  isPublished Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("channels")
}

// Avis des clients sur les coachs
model Review {
  id        String        @id @default(uuid())
  coachId   String
  coach     CoachProfile  @relation(fields: [coachId], references: [id], onDelete: Cascade)
  clientId  String
  client    ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  rating    Int           // 1-5
  comment   String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([coachId, clientId])
  @@map("reviews")
}

// Demandes d'entraînement des clients vers les coachs
model CoachRequest {
  id        String   @id @default(uuid())
  coachId   String
  coach     CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  clientId  String
  client    ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)
  message   String   // Message du client
  status    String   @default("pending") // pending, accepted, rejected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([coachId, clientId]) // Un client ne peut envoyer qu'une seule demande par coach
  @@map("coach_requests")
}

// Posts du mur du coach
model CoachPost {
  id          String       @id @default(uuid())
  coachId     String
  coach       CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  content     String       // Description du post
  mediaType   String?      // 'image' ou 'video'
  mediaUrl    String?      // URL du média
  isPublic    Boolean      @default(true) // Visible publiquement
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("coach_posts")
  @@index([coachId])
}

// Référentiel d'exercices (ExerciseDB)
model ExerciseReference {
  id               String   @id @default(uuid())
  exerciseDbId     String   @unique  // ID ExerciseDB original
  name             String
  bodyParts        String[] // ["CHEST", "SHOULDERS"]
  targetMuscles    String[] // ["Pectoralis Major"]
  secondaryMuscles String[] // ["Triceps", "Deltoid"]
  equipments       String[] // ["BARBELL", "DUMBBELL"]
  exerciseType     String   // "STRENGTH", "CARDIO", "STRETCHING"...
  gifUrl           String?  // URL du GIF animé
  instructions     String[] // Étapes textuelles
  createdAt        DateTime @default(now())

  // Relation vers les exercices concrets
  exercises        Exercise[]

  @@map("exercise_references")
}

// Rendez-vous entre coach et client
model Appointment {
  id              String            @id @default(uuid())
  title           String
  coachId         String
  coach           CoachProfile      @relation("CoachAppointments", fields: [coachId], references: [id], onDelete: Cascade)
  clientId        String?
  client          ClientProfile?    @relation("ClientAppointments", fields: [clientId], references: [id], onDelete: SetNull)
  startAt         DateTime
  endAt           DateTime          // startAt + durationMinutes (pré-calculé pour les conflits)
  durationMinutes Int
  locationType    LocationType
  locationDetail  String?           // adresse ou lien visio
  status          AppointmentStatus @default(PROPOSED)
  rrule           String?           // RRULE string sur le parent uniquement (null = ponctuel)
  parentId        String?           // null = racine de série ou ponctuel
  parent          Appointment?      @relation("AppointmentSeries", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children        Appointment[]     @relation("AppointmentSeries")
  message         Message?          @relation("AppointmentMessage")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([coachId, startAt])
  @@index([clientId, startAt])
  @@map("appointments")
}

// Base Ciqual (ANSES) - Aliments génériques français
model CiqualFood {
  id                 String @id @default(uuid())
  ciqualCode         String @unique
  name               String
  groupName          String?
  energyKcal100g     Float  @default(0)
  proteins100g       Float  @default(0)
  carbohydrates100g  Float  @default(0)
  fat100g            Float  @default(0)
  fiber100g          Float  @default(0)
  sugars100g         Float  @default(0)
  salt100g           Float  @default(0)

  @@map("ciqual_foods")
}
